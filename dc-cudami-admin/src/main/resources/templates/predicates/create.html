<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://github.com/thymeleaf/thymeleaf-extras-springsecurity"
      xmlns:data="https://github.com/mxab/thymeleaf-extras-data-attribute"
      layout:decorate="~{base}">
  <head>
    <title th:text="|#{predicates}: #{identifier_type_create}|">... create ...</title>
  </head>
  <body>
  <th:block layout:fragment="content">
    <div class="content-header">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">

            <form action="#" th:action="@{/predicates/new}" th:object="${predicate}" method="post">
              <div class="row">
                <div class="col-6 col-sm-9"><h1>Create a new relation type</h1></div>
                <div class="col-6 col-sm-3"><div class="float-right visible"><button type="submit" class="btn btn-primary">Save</button></div></div>
              </div>
              <div class="row">
                <div class="col-sm-12">
                  <hr>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-12">
                  <div class="localized-form">
                    <ul class="nav nav-tabs" role="tablist">
                      <li class="nav-item" th:each="language,iter : ${existingLanguages}">
                        <a
                          class="language-switcher nav-link"
                          data-toggle="tab"
                          role="tab"
                          th:classappend="${iter.index} == 0 ? active"
                          th:href="${'#' + language}"
                          th:with="languageToDisplay=${language.getDisplayName(#locale)}"
                          th:text="${#strings.isEmpty(languageToDisplay)} ? #{language_not_specified} : ${languageToDisplay}"
                          >
                          language
                        </a>
                      </li>
                      <li class="nav-item">
                        <a title="Sprache hinzufÃ¼gen" class="nav-link" data-toggle="modal" data-target="#addLanguageDialog">
                          <i class="fa fa-plus"></i>
                        </a>
                      </li>
                    </ul>
                    <div class="tab-content">
                      <div th:each="language,iter : ${existingLanguages}" th:id="${language}" class="tab-pane" th:classappend="${iter.index} == 0 ? active">
                        <div class="card">
                          <div class="card-body bg-light">
                            <div class="row">
                              <div class="col-sm-12">
                                <div class="form-group">
                                  <label th:for="label-__${language}__" class="font-weight-bold" th:text="#{lbl.label}">Label</label>
                                  <input th:id="label-__${language}__" class="form-control" required="" type="text" value="" th:field="*{label['__${language}__']}" />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="value" class="form-label font-weight-bold">Wert</label>
                    <input th:field="*{value}" id="value" required="" type="text" class="form-control" aria-invalid="true" value="">
                  </div>


                  <!--                <div class="form-group">
                                    <label for="label" class="form-label font-weight-bold">Label</label>
                  
                                    <div class="input-group" th:each="entry : *{label.entrySet()}">
                  
                                      <select id="label-locales">
                                        <th:block th:each="locale : ${allLanguages}">
                                          <option th:value="${locale.toLanguageTag()}" th:text="${locale.getDisplayName(#locale)}" th:selected="${#strings.equals(locale.language, entry.key)}">English</option>
                                        </th:block>
                                      </select>
                                      <input type="text" aria-label="Label" class="form-control" th:field="*{label['__${entry.key}__']}"/>
                                    </div>
                                  </div>-->



                </div>
              </div>
            </form>

          </div>
        </div>
      </div>
    </div>
  </th:block>

  <th:block layout:fragment="beforeBodyEnds">
    <div class="modal fade" id="addLanguageDialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" th:text="#{modal.title.choose_language}">Choose a language</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <form>
                <select id="label-locales" class="form-control">
                  <th:block th:each="locale : ${allLanguages}">
                    <option th:value="${locale.toLanguageTag()}" th:text="${locale.getDisplayName(#locale)}">English</option>
                  </th:block>
                </select>
              </form>
            </div>
          </div>
          <div class="modal-footer justify-content-between">
            <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{btn.cancel}">Cancel</button>
            <button type="submit" class="btn btn-primary" data-dismiss="modal" th:text="#{btn.add}">Add</button>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" th:inline="javascript">
      let targetLocalizedForm;
      $('#addLanguageDialog').on('show.bs.modal', function (e) {
        targetLocalizedForm = $(e.relatedTarget).parent().closest('.localized-form');
      });
      $("#addLanguageDialog").on('click', '.btn-primary', function () {
        /*[- remove class 'active' from all 'nav-item a' links -]*/
        let navTabs = $(targetLocalizedForm).children('.nav-tabs');
        $(navTabs).find('.nav-link').removeClass('active');

        /*[- append a new active tab with selected language before plus tab -]*/
        let selectedOptionValue = $('#addLanguageDialog').find('#label-locales').val();
        let selectedOptionText = $('#addLanguageDialog').find('#label-locales option:selected').text();
        /*[- clone first (other language tab), change tab specifics for new language and add it before plus tab -]*/
        let newTab = $(navTabs).children('.nav-item').first().clone();
        let navLink = $(newTab).children('.nav-link').first();
        $(navLink).attr('href', '#' + selectedOptionValue);
        $(navLink).text(selectedOptionText);
        $(navLink).addClass('active');
        let plusTab = $(navTabs).find('.nav-item').last();
        $(plusTab).before(newTab);

        /*[- append a new tab pane for new language by cloning an existing pane -]*/
        $(targetLocalizedForm).find('.tab-pane').removeClass('active');
        let newTabPane = $(targetLocalizedForm).find('.tab-pane').first().clone();
        $(newTabPane).attr('id', selectedOptionValue);
        $(newTabPane).addClass('active');
        /*[-
         * set ids and properties of form elements to be in sync with new language
         * e.g. <label for="label-en"...> -> <label for="label-am"...>
         * e.g. <input id="label-en" name="label['en']"...> -> <input id="label-am" name="label['am']"...>
        -]*/
        $(newTabPane).find('label').each(function () {
          let newForAttribute = $(this).attr('for').split('-')[0] + '-' + selectedOptionValue;
          $(this).attr('for', newForAttribute);
        });
        $(newTabPane).find('input').each(function () {
          let newIdAttribute = $(this).attr('id').split('-')[0] + '-' + selectedOptionValue;
          $(this).attr('id', newIdAttribute);
          let newNameAttribute = $(this).attr('name').split('[')[0] + '[\'' + selectedOptionValue + '\']';
          $(this).attr('name', newNameAttribute);
          $(this).val('');
        });

        let tabContent = $(targetLocalizedForm).find('.tab-content').first();
        $(tabContent).append(newTabPane);
      });
    </script>
  </th:block>
</body>
</html>
